# Модель: Trace

## 1. Описание

Эта архитектура описывает **техническую трассировку** бизнес-операций в системе. Она предназначена для разработчиков и службы поддержки для отладки и анализа проблем.

Она состоит из двух связанных концепций:
- **`Trace`**: Это контейнер, представляющий одну, целостную бизнес-операцию. Он идентифицируется по `trace_id` и содержит **плоский список** всех шагов (spans), относящихся к этой операции.
- **`Trace.Span`**: Это модель, представляющая один, конкретный, атомарный **шаг** (span) внутри операции. Иерархия между шагами строится с помощью поля `parent_id`.

## 2. Назначение и решаемые задачи

Основная цель — создать эффективный и гибкий инструмент для отладки.

### Ключевые задачи:
- **Эффективность**: Передача плоского списка шагов (`spans`) гораздо эффективнее, чем конструирование и передача глубоко вложенного дерева.
- **Гибкость на клиенте**: Клиент (например, инструмент для отладки) получает все "кирпичики" сразу и может сам построить дерево вызовов.
- **Анализ ошибок**: Поля `status` и `error_message` в каждом `Span` позволяют мгновенно находить место и причину сбоя.
- **Анализ производительности**: Поля `started_at` и `finished_at` позволяют анализировать, какие шаги выполняются дольше всего.

## 3. Ключевые поля и концепции

- **`Trace` (Контейнер):**
  - `trace_id`: Глобальный ID всей операции. Связывает `Trace` с `Activity`.
  - `actor_id`: **Инициатор** всей цепочки.
  - `spans`: **Плоский список** всех шагов операции.

- **`Trace.Span` (Шаг):**
  - `id`: Уникальный ID самого шага (всегда > 0).
  - `parent_id`: ID родительского шага. Для корневого шага это поле равно `0`.
  - `name`: Техническое имя шага (`CreateLedgerTransaction`).
  - `status`, `error_message`, `context`, `started_at`, `finished_at`: Детали шага.

## 4. Сценарий использования: Покупка Плана

1.  Бэкенд в ответ на запрос возвращает **один** объект `Trace`:
    - `trace_id`: 12345
    - `actor_id`: 100
    - `spans`: `[`
        - `{ id: 1, parent_id: 0,    name: "HandlePlanPurchaseRequest", ... }`
        - `{ id: 2, parent_id: 1,    name: "CreateLedgerTransaction", status: SUCCESS, ... }`
        - `{ id: 3, parent_id: 1,    name: "CreateLedgerTransaction", status: FAILURE, error: "...", ... }`
        - `{ id: 4, parent_id: 2,    name: "DB_UpdateUserBalance", status: SUCCESS, ... }`
      `]`

### Как это видит разработчик:
-   Инструмент для отладки получает этот плоский список.
-   Он строит из него дерево, используя `id` и `parent_id`, зная, что `parent_id = 0` означает корень.
-   Разработчик мгновенно видит проблемный `Span` с `id=3` и его причину.
