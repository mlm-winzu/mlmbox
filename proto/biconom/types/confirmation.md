# Модель: Confirmation

## 1. Описание

**`Confirmation`** — это мощная и гибкая модель, представляющая собой одноразовую, защищенную сессию для подтверждения пользователем важного действия (например, вывод средств, смена пароля).

Архитектура модели позволяет создавать сложные формы с несколькими полями (пароль, 2FA, код из email) и даже с альтернативными наборами полей для подтверждения (например, "пароль + 2FA" **или** "код из email + код из SMS").

## 2. Назначение и решаемые задачи

Основная цель — унифицировать и обезопасить процесс подтверждения критически важных операций.

### Ключевые задачи:
- **Безопасность**: Обеспечивает многофакторное подтверждение.
- **Гибкость**: Позволяет создавать формы любой сложности с помощью `VerificationField` и `VerificationGroup`.
- **Управление жизненным циклом**: Четко отслеживает состояние сессии (`PENDING`, `CONFIRMED`, `EXPIRED` и т.д.).
- **Управление через политики**: Позволяет централизованно задавать правила (время жизни, лимиты попыток) через `ConfirmationPolicy`.

## 3. Ключевые поля и концепции

- `account_id`: ID аккаунта, который инициировал действие.
- `action_name`: Уникальное имя действия (например, "WITHDRAWAL"), которое позволяет бэкенду понять, какую логику выполнять после успешного подтверждения.
- `status`: Текущий статус сессии.
- `policy_id`: Обязательная ссылка на `ConfirmationPolicy`, которая определяет общие правила для этой сессии.
- `expires_at`: Точное время, когда форма станет просроченной. Рассчитывается на бэкенде в момент создания на основе `expires_in_seconds` из политики.
- `available_fields`: Список всех полей, которые **могут** быть использованы для верификации.
- `verification_groups`: Ключевая часть. Это список "наборов" полей. Пользователю достаточно полностью и правильно заполнить **один любой** из этих наборов, чтобы подтвердить действие.

## 4. Сценарии использования (кейсы)

- **Вывод средств**:
  1. Создается `Confirmation` с `action_name: "WITHDRAWAL"`.
  2. `available_fields` содержит поля для пароля, кода 2FA и кода из email.
  3. `verification_groups` содержит одну группу: `[password_id, google_2fa_id]`, что означает "нужно ввести и пароль, и 2FA".
- **Смена email**:
  1. Создается `Confirmation` с `action_name: "CHANGE_EMAIL"`.
  2. `verification_groups` содержит две группы: `[password_id]` и `[email_code_id, sms_code_id]`. Это означает, что пользователь может подтвердить действие **либо** введя текущий пароль, **либо** введя коды из email и SMS.

## 5. Связи с другими моделями

- **`Account`**: `Confirmation` **принадлежит** одному `Account`.
- **`ConfirmationPolicy`**: `Confirmation` **управляется** одной политикой.
